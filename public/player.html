<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>

  <!-- confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <title>Tambola Player</title>
</head>

<body>

<h2>üéüÔ∏è Player Panel</h2>

<div id="games"></div>

<hr>

<div id="view"></div>


<script>
const socket = io();
let currentGame = null;
let gameOver = false;   // ‚≠ê ADD THIS LINE



/* =================================================
   LOAD GAMES
================================================= */

async function loadGames(){

  const list = await fetch("/games").then(r=>r.json());

  games.innerHTML = "";

  list.forEach(id=>{
    const btn = document.createElement("button");
    btn.innerText = id;
    btn.style.margin = "6px";
    btn.onclick = ()=> openGame(id);
    games.appendChild(btn);
  });
}

loadGames();


/* =================================================
   OPEN GAME
================================================= */

async function openGame(gid){

  currentGame = gid;

  socket.emit("join", gid);

  view.innerHTML = `
    <h2>${gid}</h2>

    <h1 id="live" style="font-size:80px;text-align:center">-</h1>

    <div id="boardBox" style="margin:20px"></div>

    <h3>üèÜ Winners</h3>
    <div id="winners" class="winnerGrid"></div>

    <h3>Tickets</h3>

    <div style="margin-bottom:10px">
      üîç Find Ticket:
      <input id="searchInput" placeholder="Enter ID">
      <button onclick="searchTicket()">Find</button>
    </div>

    <div id="tickets" class="wrapper"></div>
  `;

  createBoard();
  loadTickets(gid);
}


/* =================================================
   CREATE BOARD
================================================= */

function createBoard(){

  const grid = document.createElement("div");
  grid.className = "board";

  for(let i=1;i<=90;i++){
    const d=document.createElement("div");
    d.className="num";
    d.id="num"+i;
    d.innerText=i;
    grid.appendChild(d);
  }

  boardBox.appendChild(grid);
}


/* =================================================
   SEARCH
================================================= */

function searchTicket(){

  const id = document.getElementById("searchInput").value;

  document.querySelectorAll(".card").forEach(c=>{
    c.style.outline="none";
  });

  const el = document.getElementById("ticket-"+id);

  if(el){
    el.scrollIntoView({behavior:"smooth"});
    el.style.outline="4px solid yellow";
  }
}


/* =================================================
   LOAD TICKETS
================================================= */

async function loadTickets(gid){

  tickets.innerHTML="";

  const all = await fetch(`/tickets/${gid}`).then(r=>r.json());

  all.forEach(t=> createTicket(t));
}


/* =================================================
   CREATE TICKET
================================================= */

function createTicket(t){

  const card=document.createElement("div");
  card.className="card";
  card.id = "ticket-" + t.id;

  const status=document.createElement("div");

  if(t.booked){
    status.innerHTML=`üî¥ Booked ‚Äì ${t.name || "Reserved"}`;
    status.style.color="red";
  }else{
    status.innerHTML="üü¢ Available";
    status.style.color="green";
  }

  status.style.fontWeight="bold";
  status.style.marginBottom="6px";
  card.appendChild(status);


  const title=document.createElement("div");
  title.innerText="Ticket "+t.id;
  title.style.marginBottom="5px";
  card.appendChild(title);


  const grid=document.createElement("div");
  grid.className="ticket";

  for(let r=0;r<3;r++){
    for(let c=0;c<9;c++){
      const d=document.createElement("div");
      d.className="cell";
      d.innerText=t.numbers[r][c]||"";
      grid.appendChild(d);
    }
  }

  card.appendChild(grid);
  tickets.appendChild(card);
}


/* =================================================
   SOCKET EVENTS
================================================= */

socket.on("number", n=>{

  if(!currentGame || gameOver) return;   // ‚≠ê STOP IF GAME ENDED

  live.innerText=n;

  document.querySelectorAll(".cell").forEach(c=>{
    if(c.innerText==n) c.classList.add("marked");
  });

  const el=document.getElementById("num"+n);
  if(el) el.classList.add("called");
});


/* =================================================
   LIVE WINNER ANNOUNCEMENT (REQUIRED)
================================================= */

socket.on("winner", w=>{

  if(!currentGame) return;

  if(w.type === "full") gameOver = true;   // ‚≠ê ADD THIS LINE

  const card=document.createElement("div");

  card.className="winnerCard";

  card.innerHTML=`
    <b>${labels[w.type] || w.type}</b><br>
    Ticket ${w.id}
  `;

  winners.appendChild(card);

  confetti({
    particleCount:180,
    spread:120,
    origin:{y:0.6}
  });

});


/* =================================================
   WINNER DISPLAY (NEW LAYOUT)
================================================= */

const labels = {
  early5:"üü° Early 5",
  top3:"üîµ Top 3",
  bot4:"üü£ Bottom 4",
  full:"üèÜ Full House"
};

/* =================================================
   HISTORY SYNC (NEW)
================================================= */

socket.on("history", data=>{

  // restore called numbers
  data.called.forEach(n=>{

    live.innerText = n;

    const el=document.getElementById("num"+n);
    if(el) el.classList.add("called");

    document.querySelectorAll(".cell").forEach(c=>{
      if(c.innerText==n) c.classList.add("marked");
    });

  });

  // restore winners
  Object.entries(data.winners).forEach(([type,id])=>{

    const card=document.createElement("div");
    card.className="winnerCard";

    card.innerHTML=`
      <b>${labels[type] || type}</b><br>
      Ticket ${id}
    `;

    winners.appendChild(card);

  });

});


</script>


<style>

/* winners layout */
.winnerGrid{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:20px;
}

.winnerCard{
  background:#1f2b3d;
  padding:12px 18px;
  border-radius:10px;
  font-size:14px;
  box-shadow:0 0 8px #0006;
}

</style>

</body>
</html>
